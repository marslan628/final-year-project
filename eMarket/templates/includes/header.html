{% load static %}

<!--  Top Bar -->
<div class="topbar border-bottom bg-light py-2 small">
  <div class="container d-flex justify-content-between align-items-center flex-wrap">
    <div class="text-muted d-flex align-items-center gap-3">
      <span><i class="fas fa-phone-alt me-1 text-secondary"></i> +92 325 9378291</span>
      <span><i class="fas fa-envelope me-1 text-secondary"></i> contact@emarket.pk</span>
    </div>
    <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
      <a href="https://www.facebook.com/ChoudharyMuhammadArslan" class="text-muted"><i class="fab fa-facebook-f"></i></a>
      <a href="https://www.instagram.com/choudharymuhammadarslan/" class="text-muted"><i class="fab fa-instagram"></i></a>
      <a href="https://wa.me/923229989145" class="text-muted"><i class="fab fa-whatsapp"></i></a>
    </div>
  </div>
</div>

<!-- Main Navbar -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm py-3 sticky-top">
  <div class="container-fluid px-4">
    <!-- Logo -->
    <a class="navbar-brand fw-bold me-4 d-flex align-items-center" href="{% url 'home' %}">
      <img src="{% static 'images/logo.jpg' %}" alt="Logo" width="150" height="30" class="me-2 rounded">
    </a>

    <!-- Categories Dropdown -->
    <div class="dropdown me-3">
      <button class="btn btn-outline-secondary d-flex align-items-center rounded-pill px-3" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-bars me-2 text-danger"></i> Categories
      </button>
      <ul class="dropdown-menu p-2 shadow-sm" style="width: 250px; max-height: 300px; overflow-y: auto;">
        {% for category in categories %}
          <li class="mb-1">
            <a class="dropdown-item d-flex align-items-center {% if category.id == selected_category_id %}active{% endif %}" href="?category={{ category.id }}">
              <img src="{{ category.image.url }}" class="me-2 rounded-circle" width="28" height="28" alt="{{ category.name }}">
              {{ category.name }}
              {% if category.badge %}
                <span class="badge ms-auto {{ category.badge_color }}">{{ category.badge }}</span>
              {% endif %}
            </a>
          </li>
        {% empty %}
          <li><span class="dropdown-item text-muted">No categories found</span></li>
        {% endfor %}
      </ul>
    </div>

    <!-- Search Form -->
    <form class="d-flex flex-grow-1 mx-2" method="GET" action="{% url 'search_products' %}">
      <div class="input-group rounded-pill overflow-hidden border border-danger">
        <select name="category" class="form-select border-0" style="max-width: 160px;">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
        <input type="search" name="q" class="form-control border-0" placeholder="Search Item..." required>
        <button class="btn btn-danger rounded-0 px-4" type="submit"><i class="fas fa-search"></i></button>
      </div>
    </form>

    <!-- Icons -->
    <div class="d-flex align-items-center ms-3 gap-3">
      <!-- ðŸ›’ Cart -->
      <a href="#" id="cart-icon" class="text-dark position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar">
        <i class="fas fa-shopping-cart fs-5"></i>
        {% if cart.total_items > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{ cart.total_items }}
        </span>
        {% endif %}
        <br>
      </a>

<!-- ðŸ‘¤ User Dropdown -->
{% if user.is_authenticated %}
  <div class="dropdown text-center">
    <a href="#" class="text-dark text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
      <i class="fas fa-user-circle fs-4"></i><br>
      <small>{{ user.username }}</small>
    </a>
    <ul class="dropdown-menu dropdown-menu-end shadow rounded-3 p-2">
      
      {% if user.is_superuser %}
        <!-- Admin Panel -->
        <li class="dropdown-header text-muted fw-semibold">Admin Panel</li>
        <li><a class="dropdown-item" href="{% url 'admin_dashboard' %}"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
        <li><a class="dropdown-item" href="{% url 'admin_product_list' %}"><i class="fas fa-boxes me-2"></i>Manage Products</a></li>
        <li><a class="dropdown-item" href="{% url 'admin_manage_orders' %}"><i class="fas fa-clipboard-list me-2"></i>Orders</a></li>
        <li><a class="dropdown-item" href="{% url 'admin_vendor_withdrawals' %}"><i class="fas fa-money-check-alt me-2"></i>Withdrawals</a></li>
        <li><a class="dropdown-item" href="{% url 'vendor_list' %}"><i class="fas fa-users-cog me-2"></i>Vendors</a></li>
        <li><a class="dropdown-item" href="{% url 'customer_list' %}"><i class="fas fa-user-friends me-2"></i>Customers</a></li>
        <li><hr class="dropdown-divider"></li>
      {% elif customeruser.is_vendor %}
        <!-- Vendor Panel -->
        <li class="dropdown-header text-muted fw-semibold">Vendor Panel</li>
        <li><a class="dropdown-item" href="{% url 'vendor_dashboard' %}"><i class="fas fa-store me-2"></i>Dashboard</a></li>
        <li><a class="dropdown-item" href="{% url 'edit_vendor_profile' %}"><i class="fas fa-user-edit me-2"></i>Edit Profile</a></li>
        <li><a class="dropdown-item" href="{% url 'product_dashboard' %}"><i class="fas fa-box me-2"></i>My Products</a></li>
        <li><a class="dropdown-item" href="{% url 'vendor_manage_orders' %}"><i class="fas fa-shopping-cart me-2"></i>Customer Orders</a></li>
        <li><a class="dropdown-item" href="{% url 'vendor_earnings' %}"><i class="fas fa-wallet me-2"></i>Earnings</a></li>
        <li><a class="dropdown-item" href="{% url 'payment_history' %}"><i class="fas fa-credit-card me-2"></i>Payments</a></li>
        <li><hr class="dropdown-divider"></li>
      {% else %}
        <!-- Customer Panel -->
        <li class="dropdown-header text-muted fw-semibold">Customer Panel</li>
        <li><a class="dropdown-item" href="{% url 'customer_dashboard' %}"><i class="fas fa-home me-2"></i>Dashboard</a></li>
        <li><a class="dropdown-item" href="{% url 'edit_profile' %}"><i class="fas fa-user-edit me-2"></i>My Profile</a></li>
        <li><a class="dropdown-item" href="{% url 'my_orders' %}"><i class="fas fa-box-open me-2"></i>My Orders</a></li>
        <li><a class="dropdown-item" href="{% url 'track_order' %}"><i class="fas fa-search-location me-2"></i>Track Order</a></li>
        <li><a class="dropdown-item" href="{% url 'payment_history' %}"><i class="fas fa-credit-card me-2"></i>Payments</a></li>
        <li><hr class="dropdown-divider"></li>
      {% endif %}

      <!-- Shared Options -->
      <li><a class="dropdown-item" href="{% url 'change_password' %}"><i class="fas fa-key me-2"></i>Change Password</a></li>
      <li><a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
    </ul>
  </div>
{% else %}
  <a href="#" class="text-dark text-decoration-none text-center" data-bs-toggle="modal" data-bs-target="#loginModal">
    <i class="fas fa-sign-in-alt fs-5"></i><br><small>Login</small>
  </a>
{% endif %}



    </div>
  </div>
</nav>

<!--  Modern Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <form method="POST" action="{% url 'login' %}">
        {% csrf_token %}
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title fw-bold">Welcome Back!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body py-4 px-4">
          <div class="mb-3">
            <label class="form-label">Username or Email</label>
            <input type="text" class="form-control rounded-3" name="username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control rounded-3" name="password" required>
          </div>
          <div class="form-text text-end mb-3">
            <a href="{% url 'password_reset'%}" class="text-decoration-none">Forgot Password?</a>
          </div>
          <button type="submit" class="btn btn-danger w-100 rounded-pill py-2">Login</button>
        </div>
        <div class="modal-footer border-top-0 text-center">
          <small>Don't have an account? <a href="#" class="text-danger">Sign up</a></small>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… Professional Cart Sidebar -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-semibold" id="cartSidebarLabel">
      <i class="fas fa-shopping-cart me-2 text-danger"></i> Your Cart
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    {% if cart.total_items > 0 %}
      <div class="flex-grow-1">
        {% for item in cart.items.all %}
          <div class="d-flex mb-3 border-bottom pb-3">
            <img src="{{ item.product.image.url }}" class="rounded me-3" style="width: 70px; height: 70px; object-fit: cover;" alt="{{ item.product.name }}">
            <div class="flex-grow-1">
              <h6 class="fw-semibold mb-1">{{ item.product.name }}</h6>
              <small class="text-muted d-block mb-1">
                {% if item.color %} Color: {{ item.color.name }} | {% endif %}
                {% if item.size %} Size: {{ item.size.name }} | {% endif %}
                Qty: {{ item.quantity }}
              </small>
              <div class="text-danger fw-bold">PKR {{ item.total_price }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="border-top pt-3 mt-3">
        <div class="d-flex justify-content-between fw-bold mb-3">
          <span>Total:</span>
          <span class="text-danger">PKR {{ cart.total_amount }}</span>
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'cart_view' %}" class="btn btn-outline-dark w-50">View Cart</a>
          <a href="{% url 'checkout' %}" class="btn btn-danger w-50">Checkout</a>
        </div>
      </div>
    {% else %}
      <div class="text-center text-muted mt-5">
        <i class="fas fa-shopping-bag fa-3x mb-3"></i>
        <p class="mb-0">Your cart is empty.</p>
      </div>
    {% endif %}
  </div>
</div>
<script>
 
  const tooltipTriggerList = [...document.querySelectorAll('[data-bs-toggle="tooltip"]')]
  tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>
