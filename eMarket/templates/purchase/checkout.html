{% extends 'base.html' %}
{% block title %}Checkout | eMarket{% endblock %}
{% load static %}
{% load math_filters %}
{% load custom_filters %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<div class="container py-5">
    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <h2 class="mb-5 text-center fw-bold"><i class="fas fa-cash-register me-2"></i> Secure Checkout</h2>

    <div class="row g-4">
        <!-- Billing Details -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm rounded-4 p-4">
                <h4 class="mb-4 fw-semibold text-dark"><i class="fas fa-user me-2"></i> Billing Details</h4>
                <form method="POST" novalidate id="checkout-form">
                    {% csrf_token %}

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" name="full_name" id="full_name" placeholder="Full Name" required value="{{ form_data.full_name|default_if_none:'' }}">
                        <label for="full_name">Full Name</label>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" name="email" id="email" placeholder="Email Address" required value="{{ form_data.email|default_if_none:'' }}">
                        <label for="email">Email Address</label>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>

                    {% if not request.user.is_authenticated %}
                    <div class="form-floating mb-3">
                        <input type="password" name="password" class="form-control" id="password" placeholder="Create Password" required>
                        <label for="password">Create Password</label>
                        <div class="invalid-feedback">Please create a password.</div>
                    </div>
                    {% endif %}

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" name="phone" id="phone" placeholder="Phone Number" required value="{{ form_data.phone|default_if_none:'' }}">
                        <label for="phone">Phone Number</label>
                        <div class="invalid-feedback">Please enter a valid phone number.</div>
                    </div>

                    <div class="form-floating mb-3">
                        <textarea class="form-control" name="address" id="address" style="height: 100px" placeholder="Address" required>{{ form_data.address|default_if_none:'' }}</textarea>
                        <label for="address">Address</label>
                        <div class="invalid-feedback">Please enter your address.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3 form-floating">
                            <input type="text" class="form-control" name="city" id="city" placeholder="City" required value="{{ form_data.city|default_if_none:'' }}">
                            <label for="city">City</label>
                            <div class="invalid-feedback">City is required.</div>
                        </div>
                        <div class="col-md-6 mb-3 form-floating">
                            <input type="text" class="form-control" name="zip_code" id="zip_code" placeholder="ZIP Code" required value="{{ form_data.zip_code|default_if_none:'' }}">
                            <label for="zip_code">ZIP Code</label>
                            <div class="invalid-feedback">ZIP Code is required.</div>
                        </div>
                    </div>

                    <!-- Payment -->
                    <div class="card bg-light border-0 shadow-sm rounded-4 p-4 mt-4">
                        <h5 class="fw-semibold text-dark mb-3"><i class="fas fa-credit-card me-2 text-primary"></i> Payment Information</h5>

                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="card_number" id="card_number" placeholder="Card Number" maxlength="16" required value="{{ form_data.card_number|default_if_none:'' }}">
                            <label for="card_number">Card Number</label>
                            <div class="invalid-feedback">Only Visa (4xxx) and MasterCard (5xxx) are accepted.</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3 form-floating">
                                <input type="text" class="form-control" name="expiry" id="expiry" placeholder="MM/YY" maxlength="5" required value="{{ form_data.expiry|default_if_none:'' }}">
                                <label for="expiry">Expiry (MM/YY)</label>
                                <div class="invalid-feedback">Use MM/YY format (e.g., 09/25).</div>
                            </div>
                            <div class="col-md-6 mb-3 form-floating">
                                <input type="text" class="form-control" name="cvv" id="cvv" placeholder="CVV" maxlength="4" required value="{{ form_data.cvv|default_if_none:'' }}">
                                <label for="cvv">CVV</label>
                                <div class="invalid-feedback">Enter a valid CVV (3-4 digits).</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button id="place-order-btn" type="submit" class="btn btn-primary btn-lg rounded-pill d-flex justify-content-center align-items-center gap-2">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span>Place Order</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-lg rounded-4 p-4 bg-light">
                <h4 class="mb-4 fw-semibold text-dark"><i class="fas fa-box-open me-2 text-secondary"></i> Order Summary</h4>
                {% for item in cart.items.all %}
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <div class="fw-semibold">{{ item.product.name }}</div>
                            {% if item.color %}
                                <div><small class="text-muted">Color: {{ item.color.color_name }}</small></div>
                            {% endif %}
                            {% if item.size %}
                                <div><small class="text-muted">Size: {{ item.size.size_label }}</small></div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <div>{{ item.quantity }} Ã— PKR {{ item.total_price|div:item.quantity|floatformat:0 }}</div>
                            <small class="text-muted">= PKR {{ item.total_price|floatformat:0 }}</small>
                        </div>
                    </div>
                {% endfor %}

           {% if cart.coupon %}
  <div class="alert alert-success d-flex justify-content-between align-items-center small py-2 px-3 rounded-3">
    <span>
      Coupon <strong>{{ cart.coupon.code }}</strong> applied
    </span>
    {% if cart.coupon.discount_type == "percentage" %}
      <span class="badge bg-success">{{ cart.coupon.discount }}% OFF</span>
    {% else %}
      <span class="badge bg-success">Rs. {{ cart.coupon.discount }} OFF</span>
    {% endif %}
  </div>
{% endif %}


                <hr>
                <div class="d-flex justify-content-between fs-5 fw-bold text-primary">
                    <span>Total</span>
                    <span>PKR {{ cart.total_amount|floatformat:0 }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('checkout-form');

    form.addEventListener('submit', function (e) {
        let valid = true;

        const fullName = document.getElementById('full_name');
        const email = document.getElementById('email');
        const phone = document.getElementById('phone');
        const card = document.getElementById('card_number');
        const expiry = document.getElementById('expiry');
        const cvv = document.getElementById('cvv');

        // Basic validations
        if (!/^\d{16}$/.test(card.value) || (!card.value.startsWith("4") && !card.value.startsWith("5"))) {
            card.classList.add('is-invalid');
            valid = false;
        } else card.classList.remove('is-invalid');

        if (!/^\d{2}\/\d{2}$/.test(expiry.value)) {
            expiry.classList.add('is-invalid');
            valid = false;
        } else expiry.classList.remove('is-invalid');

        if (!/^[\d]{3,4}$/.test(cvv.value)) {
            cvv.classList.add('is-invalid');
            valid = false;
        } else cvv.classList.remove('is-invalid');

        [fullName, email, phone].forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                valid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!valid) {
            e.preventDefault();
            return;
        }

        const btn = document.getElementById("place-order-btn");
        btn.querySelector(".spinner-border").classList.remove("d-none");
        btn.disabled = true;
    });
</script>
{% endblock %}
